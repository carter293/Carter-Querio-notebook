---
date: 2025-12-27T20:24:40+00:00
planner: AI Assistant
topic: "Plotly JSON Rendering - Use Plotly.js Directly"
tags: [planning, implementation, plotly, frontend, output-renderer]
status: draft
last_updated: 2025-12-27
last_updated_by: AI Assistant
---

# Plotly JSON Rendering Implementation Plan

**Date**: 2025-12-27T20:24:40+00:00
**Planner**: AI Assistant

## Overview

Implement Plotly chart rendering using the Plotly.js library directly (marimo pattern) instead of HTML injection. This fixes the issue where Plotly charts don't render because `dangerouslySetInnerHTML` doesn't execute embedded scripts.

## Current State Analysis

### Problem
Plotly charts generated by `fig.to_html()` contain `<script>` tags that must execute to render the chart. When inserted via React's `dangerouslySetInnerHTML`, these scripts are parsed but **not executed** due to browser security restrictions. The chart div appears empty.

### Current Implementation

**Backend** (`backend/executor.py:31-36`):
```python
import plotly.graph_objects as go
if isinstance(obj, go.Figure):
    html = obj.to_html(include_plotlyjs='cdn', div_id=None)
    return Output(mime_type=MimeType.HTML, data=html)
```

**Frontend** (`frontend/src/components/OutputRenderer.tsx:36-45`):
```tsx
case 'text/html':
  return (
    <div
      dangerouslySetInnerHTML={{ __html: output.data }}
      style={{ width: '100%' }}
    />
  );
```

### Key Discoveries
- **Vega-Lite pattern exists**: `VegaLiteRenderer` component uses `vega-embed` library directly with a `useRef` + `useEffect` pattern - we will mirror this for Plotly
- **MIME type enum**: `backend/models.py` defines `MimeType` enum with existing types like `VEGA_LITE = "application/vnd.vegalite.v5+json"`
- **Type export issues**: `api-client.ts` is missing exports for `Output` and `NotebookMetadata` types - will fix as part of this work

## System Context Analysis

This change follows the **marimo pattern** of using charting libraries directly in the frontend rather than injecting HTML. This is the same pattern already used for Vega-Lite charts. The approach is:
1. Backend serializes chart to JSON specification
2. Frontend uses the charting library to render from JSON
3. No script execution needed - library handles rendering

This addresses the **root cause** (scripts don't execute in `dangerouslySetInnerHTML`) rather than a workaround (extracting and executing scripts).

## Desired End State

1. Plotly figures render as interactive charts in the notebook
2. Charts support zoom, pan, hover tooltips, and other Plotly interactivity
3. Pattern is consistent with existing Vega-Lite implementation
4. No HTML injection or script execution required

### Verification
- Run demo notebook with Plotly cell: `import plotly.express as px; px.bar(x=['a','b','c'], y=[1,2,3])`
- Chart renders visibly with interactive features
- No console errors related to Plotly

## What We're NOT Doing

- **Not supporting HTML output for Plotly** - migrating fully to JSON (cleaner, more secure)
- **Not implementing script extraction** - that's a workaround with security concerns
- **Not adding Plotly Express types** - just using the basic Plotly.js rendering API

## Implementation Approach

1. Add new MIME type `PLOTLY_JSON` to backend
2. Change backend to use `fig.to_json()` instead of `fig.to_html()`
3. Add `plotly.js` package to frontend
4. Create `PlotlyRenderer` component mirroring `VegaLiteRenderer`
5. Add case in `OutputRenderer` switch for new MIME type
6. Fix existing TypeScript export issues in `api-client.ts`

---

## Phase 1: Backend Changes

### Overview
Change Plotly output from HTML to JSON format and add new MIME type.

### Changes Required:

#### 1. Add MIME Type
**File**: `backend/models.py`
**Changes**: Add `PLOTLY_JSON` to `MimeType` enum

```python
class MimeType(str, Enum):
    """Known MIME types for output rendering"""
    PNG = "image/png"
    HTML = "text/html"
    PLAIN = "text/plain"
    VEGA_LITE = "application/vnd.vegalite.v5+json"
    JSON = "application/json"
    PLOTLY_JSON = "application/vnd.plotly.v1+json"  # NEW
```

#### 2. Update Plotly Serialization
**File**: `backend/executor.py`
**Changes**: Change `to_html()` to `to_json()` and use new MIME type

```python
# Plotly figure
try:
    import plotly.graph_objects as go
    if isinstance(obj, go.Figure):
        # Use to_json() for frontend rendering with Plotly.js
        import json
        spec = json.loads(obj.to_json())
        return Output(mime_type=MimeType.PLOTLY_JSON, data=spec)
except ImportError:
    pass
```

### Success Criteria:

#### Automated Verification:
- [x] Backend tests pass: `cd backend && python -m pytest`
- [x] Backend starts without errors: `uvicorn backend.main:app`

#### Manual Verification:
- [ ] Run Plotly cell and verify WebSocket message contains `application/vnd.plotly.v1+json` MIME type
- [ ] Verify JSON spec contains `data` and `layout` keys

---

## Phase 2: Frontend Dependencies

### Overview
Add Plotly.js package and TypeScript types.

### Changes Required:

#### 1. Install Plotly.js
**File**: `frontend/package.json`
**Changes**: Add plotly.js dependency

```bash
cd frontend && npm install plotly.js-dist-min @types/plotly.js
```

Note: Using `plotly.js-dist-min` for smaller bundle size. This is the minified distribution that includes all chart types.

### Success Criteria:

#### Automated Verification:
- [x] Package installs without errors: `npm install`
- [x] No peer dependency warnings for plotly.js

---

## Phase 3: Frontend PlotlyRenderer Component

### Overview
Create a PlotlyRenderer component following the VegaLiteRenderer pattern.

### Changes Required:

#### 1. Fix Type Exports
**File**: `frontend/src/api-client.ts`
**Changes**: Export missing types (Output, NotebookMetadata)

Add these exports:
```typescript
// Re-export OutputResponse as Output for convenience
export type { OutputResponse as Output, NotebookMetadataResponse as NotebookMetadata } from './client';
```

#### 2. Create PlotlyRenderer and Update OutputRenderer
**File**: `frontend/src/components/OutputRenderer.tsx`
**Changes**: Add PlotlyRenderer component and new case in switch

```tsx
import { useEffect, useRef } from 'react';
import { Output, TableData } from '../api-client';
import embed from 'vega-embed';
import type { VisualizationSpec } from 'vega-embed';
import Plotly from 'plotly.js-dist-min';

// ... existing code ...

// Add new case in OutputRenderer switch statement:
case 'application/vnd.plotly.v1+json':
  if (typeof output.data === 'object' && output.data !== null) {
    return <PlotlyRenderer spec={output.data as PlotlySpec} />;
  }
  return <div>Error: Expected Plotly spec object</div>;

// ... existing code ...

// Add type for Plotly spec
interface PlotlySpec {
  data: Plotly.Data[];
  layout?: Partial<Plotly.Layout>;
  config?: Partial<Plotly.Config>;
}

// Add PlotlyRenderer component (similar to VegaLiteRenderer)
interface PlotlyRendererProps {
  spec: PlotlySpec;
}

function PlotlyRenderer({ spec }: PlotlyRendererProps) {
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (containerRef.current) {
      Plotly.newPlot(
        containerRef.current,
        spec.data,
        spec.layout || {},
        { responsive: true, displayModeBar: true }
      ).catch(err => {
        console.error('Plotly rendering error:', err);
      });
    }

    // Cleanup on unmount
    return () => {
      if (containerRef.current) {
        Plotly.purge(containerRef.current);
      }
    };
  }, [spec]);

  return <div ref={containerRef} style={{ width: '100%' }} />;
}
```

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compiles: `cd frontend && npm run build`
- [x] No linting errors in OutputRenderer.tsx

#### Manual Verification:
- [ ] PlotlyRenderer component renders without errors
- [ ] Plotly charts are interactive (hover tooltips work)

---

## Phase 4: Integration Testing

### Overview
End-to-end verification that Plotly charts render correctly.

### Success Criteria:

#### Manual Verification:
- [ ] Start backend: `cd backend && uvicorn main:app --reload`
- [ ] Start frontend: `cd frontend && npm run dev`
- [ ] Create new notebook or load demo notebook
- [ ] Run Plotly cell with code:
  ```python
  import plotly.express as px
  px.bar(x=['a', 'b', 'c'], y=[1, 2, 3], title='Test Chart')
  ```
- [ ] Chart renders with title "Test Chart"
- [ ] Hover tooltips show data values
- [ ] Zoom/pan controls in toolbar work
- [ ] Chart resizes with browser window

---

## Testing Strategy

### Unit Tests
- Backend: Verify `to_mime_bundle()` returns correct MIME type and JSON structure for Plotly figures
- Frontend: Component renders without crashing when given valid spec

### Integration Tests
- WebSocket message flow delivers Plotly JSON correctly
- Chart renders after execution completes

### Manual Testing Steps
1. Run `import plotly.express as px; px.scatter(x=[1,2,3], y=[1,4,9])` - scatter plot renders
2. Run `import plotly.graph_objects as go; go.Figure(data=go.Bar(x=[1,2,3], y=[1,2,3]))` - bar chart renders
3. Run complex Plotly code with subplots - multiple charts render
4. Resize browser window - charts respond appropriately

## Performance Considerations

- **Bundle size**: `plotly.js-dist-min` is ~3MB minified. Consider lazy loading if startup time is a concern.
- **Memory**: Plotly.purge() is called on unmount to prevent memory leaks
- **Responsiveness**: Using `responsive: true` config so charts resize with container

## Migration Notes

- Existing notebooks with Plotly cells will work automatically after backend change
- No data migration needed - outputs are regenerated on execution
- Old HTML outputs in stored notebooks will show as unsupported type until re-executed

## References

- Original research: `thoughts/shared/research/2025-12-27-plotly-html-not-rendering.md`
- VegaLiteRenderer pattern: `frontend/src/components/OutputRenderer.tsx:119-134`
- Backend MIME types: `backend/models.py:16-22`
- Plotly.js documentation: https://plotly.com/javascript/

